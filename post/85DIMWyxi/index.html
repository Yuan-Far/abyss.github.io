<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>é’å±‹</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="æˆ‘æœ‰ä¸€å£¶é…’ï¼Œè¶³ä»¥æ…°é£å°˜"/>
<meta name="keywords" content="æˆ‘æœ‰ä¸€å£¶é…’ï¼Œè¶³ä»¥æ…°é£å°˜"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://qingwu-aby.github.io/favicon.ico">

<link rel="stylesheet" href="https://qingwu-aby.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://qingwu-aby.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://qingwu-aby.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://qingwu-aby.github.io/images/avatar.png" alt="é’å±‹"
                 class="img-responsive">
        </figure>
        <a href="https://qingwu-aby.github.io/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>é’å±‹</h2>
        <p>æˆ‘æœ‰ä¸€å£¶é…’ï¼Œè¶³ä»¥æ…°é£å°˜</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- æ ‡ç­¾ -->
        <div class="fh5co-box">
            <a href="https://qingwu-aby.github.io/tags/"><h3 class="heading">ğŸ‘‰æ ‡ç­¾</h3></a>
            <ul>
                
                    <li><a href="https://qingwu-aby.github.io/tag/WHkzkmUVJ/">JSåŸºç¡€</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/HDG5upSe4/">ç®—æ³•å’Œæ•°æ®ç»“æ„</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/o-FN4Uam8n/">todo</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/H8FJNbNzO/">ä¸€äº›é—®é¢˜</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/iheqDLI6k/">åŸ‹ç‚¹</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            é¦–é¡µ
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            åˆ†ç±»
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            æ ‡ç­¾
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            å…³äº
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://qingwu-aby.github.io">é’å±‹ </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>ğŸ‘ˆ Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next ğŸ‘‰</span></a>-->

    <!-- ç­‰grideaå‡ºè‡ªå®šä¹‰é¡µé¢åŠŸèƒ½å†ä¼˜åŒ–ä¸€ä¸‹ -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
            </span>
            <h2 class="fh5co-article-title animate-box">Reactæºç ç³»åˆ—3---Renderé˜¶æ®µ</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2020-10-06</li>
                <li>2063å­—</li>
                <li>9 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <blockquote>
<p><code>FiberèŠ‚ç‚¹</code>å¦‚ä½•è¢«åˆ›å»ºï¼Ÿ<br>
å¦‚ä½•æ„å»ºä¸€æ£µ<code>Fiberæ ‘</code>ï¼Ÿ</p>
</blockquote>
<!-- more -->
<h1 id="render-æµç¨‹">render æµç¨‹</h1>
<p><code>renderé˜¶æ®µ</code>å¼€å§‹äº<code>performSyncWorkOnRoot</code>æˆ–è€…<code>performConcurrentWorkOnRoot</code>çš„æ–¹æ³•è°ƒç”¨ã€‚å…·ä½“çš„è°ƒç”¨æ–¹æ³•å–å†³ä¸æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„</p>
<blockquote>
<p>performSyncWorkOnRoot:</p>
</blockquote>
<pre><code class="language-javascript">// performSyncWorkOnRootåŒæ­¥è°ƒç”¨ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•
function workLoopSync() {
    while(workInProgress !== null) {
        // do something
        performUnitOfWork(workInProgress)
    }
}
</code></pre>
<pre><code class="language-javascript">//performConcurrentWorkOnRootå¼‚æ­¥è°ƒç”¨æ‰§è¡Œ
function workLoopConcurrent() {
    while(workInProgress !== null &amp;&amp; !shouldYield()) {
        performUnitOfWork(workInProgress)
    }
}
</code></pre>
<ul>
<li>åŒæ­¥è°ƒç”¨å’Œå¼‚æ­¥è°ƒç”¨çš„åŒºåˆ«åœ¨äºæ˜¯å¦è°ƒç”¨<code>shouldYield()</code>ï¼Œç”¨äºåˆ¤æ–­å½“å‰å…³é”®å¸§æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼›å¦‚æœå½“å‰æµè§ˆå™¨å¸§æ²¡æœ‰å‰©ä½™æ—¶é—´çš„è¯,<code>shouldYield</code>åˆ™ä¼šä¸­æ­¢å¾ªç¯è¿‡ç¨‹ï¼Œç›´åˆ°æµè§ˆå™¨æœ‰å‰©ä½™æ—¶é—´</li>
<li><code>workInProgress</code>ä»£è¡¨å½“å‰å·²ç»åˆ›å»ºçš„<code>workInProgress Fiber</code></li>
<li><code>preformUnitOfWork</code>æ–¹æ³•ä¼šåˆ›å»ºä¸‹ä¸€ä¸ª<code>FiberèŠ‚ç‚¹</code>å¹¶èµ‹å€¼ç»™<code>wornInProgress</code>ï¼Œå¹¶å°†<code>workInProgress</code>ä¸å·²ç»åˆ›å»ºçš„<code>Fiber èŠ‚ç‚¹</code>è¿æ¥èµ·æ¥æ„æˆ<code>Fiber æ ‘</code></li>
<li><code>Fiber Reconciler</code>æ¥è‡ªäº<code>Stack Reconciler</code>ï¼Œé€šè¿‡éå†çš„æ–¹å¼å®ç°å¯ä»¥ä¸­æ–­çš„é€’å½’</li>
<li><a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1599">workLoopConcurrent</a>è°ƒç”¨çš„ä¸»è¦æ–¹æ³•å°±æ˜¯<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1606">performUnitOfWork</a>, <code>performUnitOfWork</code>ä¹Ÿå› æ­¤åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ</li>
</ul>
<h2 id="é€’">'é€’'</h2>
<ul>
<li>ä»<code>rootFiber</code>å¼€å§‹ï¼Œå‘ä¸‹ï¼Œæ·±åº¦ä¼˜å…ˆéå†ï¼ˆæ ˆç»“æ„ï¼‰ã€‚ä¸ºéå†åˆ°çš„æ¯ä¸€ä¸ª<code>Fiber èŠ‚ç‚¹</code>è°ƒç”¨<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3058">beginWork</a></li>
<li><a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3058">beginWork</a>ä¼šæ ¹æ®ä¼ å…¥çš„<code>Fiber èŠ‚ç‚¹</code>åˆ›å»ºä¸€ä¸ª<code>å­FiberèŠ‚ç‚¹</code>ï¼Œå¹¶å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹é“¾æ¥èµ·æ¥</li>
<li>å½“éå†åˆ°å­èŠ‚ç‚¹çš„æ—¶å€™å°±ä¼šè¿›è¡Œåˆ°<code>å½’</code>çš„é˜¶æ®µ</li>
</ul>
<h2 id="å½’">'å½’'</h2>
<ul>
<li>åœ¨è¿™ä¸€é˜¶æ®µä¼šè°ƒç”¨<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L652">completeWork</a>æ¥å¤„ç†<code>FiberèŠ‚ç‚¹</code></li>
<li>å½“æŸä¸ª<code>FiberèŠ‚ç‚¹</code>æ‰§è¡Œå®Œ<code>completeWork</code>ï¼Œå¦‚æœå­˜åœ¨å…¶<code>å…„å¼ŸèŠ‚ç‚¹</code>ï¼ˆ<code>fiber.sibling !== null</code>ï¼‰,å°†ä¼šè¿›å…¥<code>å…„å¼ŸFiber</code>çš„â€˜é€’â€™é˜¶æ®µ</li>
<li><strong>é€’****å½’</strong>çš„è¿‡ç¨‹ä¼šäº¤é”™æ‰§è¡Œï¼Œä¸€ç›´åˆ°<strong>å½’</strong>åˆ°æœ€ç»ˆçš„<code>rootFiber</code>ã€‚æœ€åï¼Œ<code>renderé˜¶æ®µ</code>ç»“æŸ</li>
</ul>
<h3 id="example">Exampleï¼š</h3>
<p>ä½¿ç”¨ä¸Šä¸€èŠ‚ç”¨åˆ°çš„<code>FunctionComponent</code>ï¼š</p>
<pre><code class="language-javascript">function App() {
    return (
        &lt;div&gt;
            hello
            &lt;span&gt;React&lt;/span&gt;
        &lt;/div&gt;
    )
}
</code></pre>
<p><code>Fiberæ ‘</code>ç»“æ„å¦‚ä¸‹ï¼š<br>
<img src="https://qingwu-aby.github.io/post-images/1602065787452.png" alt="" loading="lazy"><br>
<code>renderé˜¶æ®µ</code>æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<blockquote>
<ol>
<li>rootFiber        beginWork</li>
<li>App Fiber       beginWork</li>
<li>div Fiber        beginWork</li>
<li>&quot;Hello&quot; Fiber  beginWork</li>
<li>&quot;Hello&quot; Fiber  completeWork</li>
<li>span Fiber     beginWork<br>
<s>7. &quot;React&quot; Fiber beginWork // Reactä¼šä¼˜åŒ–å•ä¸€æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šå‡ºç°</s><br>
<s>8. &quot;React&quot; Fiber completeWork</s></li>
<li>span Fiber     completeWork</li>
<li>div Fiber      completeWork</li>
<li>App Fiber     completeWork</li>
<li>rootFiber     completeWork</li>
</ol>
</blockquote>
<p><strong>performUnitOfWorké€’å½’å†™æ³•ï¼š</strong></p>
<pre><code class="language-javascript">function performUnitOfWork(fiber)  {
    // beginWork()
    if (fiber.child) {
        performUnitOfWork(fiber.child)
    }
    // completeWork
    if (fiber.sibling) {
        performUnitOfWork(fiber.sibling)
    }
}
</code></pre>
<h1 id="beginwork">beginWork</h1>
<blockquote>
<p><code>beginWork</code>çš„å·¥ä½œæ˜¯ä¼ å…¥å½“å‰çš„<code>fiber èŠ‚ç‚¹</code>ï¼Œåˆ›å»º<code>å­FiberèŠ‚ç‚¹</code></p>
</blockquote>
<pre><code class="language-javascript">function beginWork(
    current: Fiber | null, // 
    workInProgress: Fiber,
    renderLanes: Lanes
): Fiber | null {
    // do something
}
</code></pre>
<p>å‚æ•°ï¼š</p>
<ul>
<li>current:  å½“å‰ç»„ä»¶å¯¹åº”çš„<code>Fiber</code>èŠ‚ç‚¹åœ¨ä¸Šä¸€æ¬¡æ›´æ–°æ—¶å€™çš„ <code>Fiber</code>----<code>workInProgress.alternate</code></li>
<li>workInProgress: å½“å‰ç»„ä»¶å¯¹åº”çš„<code>FiberèŠ‚ç‚¹</code></li>
<li>renderLanesï¼š ä¼˜å…ˆçº§</li>
</ul>
<blockquote>
<p>åœ¨<a href="https://qingwu-aby.github.io/post/BlZ715Y5q/#%E5%8F%8C%E7%BC%93%E5%AD%98fiber%E6%A0%91">åŒç¼“å­˜æœºåˆ¶</a>è¿™ä¸€å—æœ‰æåˆ°ï¼Œç»„ä»¶<code>mount</code>çš„æ—¶å€™ï¼Œå› ä¸ºæ˜¯åœ¨é¦–å±æ¸²æŸ“ï¼Œæ­¤æ—¶é¡µé¢å¹¶æ²¡æœ‰æŒ‚è½½DOMï¼Œæ˜¯ä¸å­˜åœ¨å½“å‰ç»„ä»¶å¯¹åº”çš„<code>Fiber èŠ‚ç‚¹</code>åœ¨ä¸Šæ¬¡æ›´æ–°æ—¶çš„<code>Fiber èŠ‚ç‚¹</code>çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨<code>mount</code>çš„æ—¶å€™<code>current === null</code></p>
</blockquote>
<blockquote>
<p><strong>current === null</strong>æ¥åˆ¤æ–­ç»„ä»¶å½“å‰æ˜¯åœ¨<code>mount</code>è¿˜æ˜¯<code>update</code></p>
</blockquote>
<p>åŸºäºç»„ä»¶æ‰€å¤„çš„ä¸åŒçŠ¶æ€ï¼ˆ<code>mount</code>å’Œ<code>update</code>ï¼‰ï¼Œ<code>beginWork</code>å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li><code>mount</code>æ—¶ï¼š é™¤<code>fiberRootNode</code>ä¹‹å¤–ï¼Œ<code>current === null</code>ã€‚ä¼šæ ¹æ®<code>fiber.tag</code>çš„ä¸åŒï¼Œåˆ›å»ºä¸åŒçš„<code>å­FiberèŠ‚ç‚¹</code></li>
<li><code>update</code>æ—¶ï¼šå¦‚æœ<code>current</code>å­˜åœ¨ï¼Œåœ¨æ»¡è¶³æ¡ä»¶çš„æ—¶å€™å¯ä»¥å¤ç”¨<code>current</code>èŠ‚ç‚¹ï¼Œå…‹éš†<code>current.child</code>ä½œä¸º<code>workInProgress.child</code> ,è€Œä¸éœ€è¦æ–°å»ºä¸€ä¸ª<code>workInProgress.child</code></li>
</ul>
<pre><code class="language-javascript">function beginWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes
): Fiber | null {

  // updateæ—¶ï¼šå¦‚æœcurrentå­˜åœ¨å¯èƒ½å­˜åœ¨ä¼˜åŒ–è·¯å¾„ï¼Œå¯ä»¥å¤ç”¨currentï¼ˆå³ä¸Šä¸€æ¬¡æ›´æ–°çš„FiberèŠ‚ç‚¹ï¼‰
  if (current !== null) {
    // ...çœç•¥

    // å¤ç”¨current
    return bailoutOnAlreadyFinishedWork(
      current,
      workInProgress,
      renderLanes,
    );
  } else {
    didReceiveUpdate = false;
  }

  // mountæ—¶ï¼šæ ¹æ®tagä¸åŒï¼Œåˆ›å»ºä¸åŒçš„å­FiberèŠ‚ç‚¹
  switch (workInProgress.tag) {
    case IndeterminateComponent: 
      // ...çœç•¥
    case LazyComponent: 
      // ...çœç•¥
    case FunctionComponent: 
      // ...çœç•¥
    case ClassComponent: 
      // ...çœç•¥
    case HostRoot:
      // ...çœç•¥
    case HostComponent:
      // ...çœç•¥
    case HostText:
      // ...çœç•¥
    // ...çœç•¥å…¶ä»–ç±»å‹
  }
}
</code></pre>
<h2 id="update">update</h2>
<p>åœ¨<code>update</code>çš„æ—¶å€™å¯ä»¥ç›´æ¥å¤ç”¨å‰ä¸€æ¬¡æ›´æ–°çš„<code>å­Fiber</code>ï¼Œä¸éœ€è¦æ–°å»º<code>å­Fiber</code>çš„æƒ…å†µ,å³<code>didReceiveUpdate === false</code></p>
<pre><code class="language-javascript">if (current !== null) {
    const oldProps = current.memoizedProps;
    const newProps = workInProgress.pendingProps;

    if (
      oldProps !== newProps ||
      hasLegacyContextChanged() ||
      (__DEV__ ? workInProgress.type !== current.type : false)
    ) {
      didReceiveUpdate = true;
    } else if (!includesSomeLane(renderLanes, updateLanes)) {
      didReceiveUpdate = false;
      switch (workInProgress.tag) {
        // çœç•¥å¤„ç†
      }
      return bailoutOnAlreadyFinishedWork(
        current,
        workInProgress,
        renderLanes,
      );
    } else {
      didReceiveUpdate = false;
    }
  } else {
    didReceiveUpdate = false;
  }
</code></pre>
<ol>
<li>å½“<code>oldProps === newProps &amp;&amp; workInProgress.type === current.type</code>,ä¹Ÿå°±æ˜¯åœ¨<code>type</code>å’Œ<code>props</code>ä¸å˜çš„æƒ…å†µä¸‹</li>
<li><code>!includesSomeLane(renderLanes, updateLanes)</code>,å½“å‰çš„<code>FiberèŠ‚ç‚¹</code>ä¼˜å…ˆçº§è¾ƒä½çš„æ—¶å€™</li>
</ol>
<h2 id="mount">mount</h2>
<p>å½“ä¸æ»¡è¶³ä¼˜åŒ–çš„è·¯å¾„çš„æ—¶å€™ï¼Œå°±ä¼šå»æ–°å»º<code>å­Fiber</code><br>
æ ¹æ®<code>fiber.tag</code>çš„ä¸åŒï¼Œè¿›å…¥ä¸åŒç±»å‹çš„<code>Fiber</code>å»åˆ›å»ºé€»è¾‘</p>
<pre><code class="language-javascript">// mountæ—¶ï¼šæ ¹æ®tagä¸åŒï¼Œåˆ›å»ºä¸åŒçš„FiberèŠ‚ç‚¹
switch (workInProgress.tag) {
  case IndeterminateComponent: 
    // ...çœç•¥
  case LazyComponent: 
    // ...çœç•¥
  case FunctionComponent: 
    // ...çœç•¥
    return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderLanes,
      )
  case ClassComponent: 
    // ...çœç•¥
    return updateClassComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderLanes,
      )
  case HostRoot:
    // ...çœç•¥
  case HostComponent:
    return updateHostComponent(current, workInProgress, renderLanes);
  case HostText:
    // ...çœç•¥
  case SuspenseComponent:
     // ...çœç•¥ 
  case HostPortal:
    // ...çœç•¥
  case ForwardRef: 
    // ...çœç•¥
  case Fragment:
    // ...çœç•¥
  case Mode:
    // ...çœç•¥
  case Profiler:
    // ...çœç•¥
  case ContextProvider:
    // ...çœç•¥
  case ContextConsumer:
    // ...çœç•¥
  // ...çœç•¥å…¶ä»–ç±»å‹
}
</code></pre>
<blockquote>
<p><code>React</code>ç»„ä»¶ç±»å‹<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactWorkTags.js#L10">TagType</a></p>
</blockquote>
<p>å¯¹äºå¸¸è§çš„ç»„ä»¶ç±»å‹ï¼š <code>FunctionComponent</code>/<code>ClassComponent</code>/<code>HostComponent</code>,ä»–ä»¬åˆ†åˆ«è°ƒç”¨äº†<code>updateFunctionComponent</code>/<code>updateClassComponent</code>/<code>updateHostComponent</code>,æ ¹æ®æºç æ‰¾åˆ°æœ€ç»ˆè°ƒç”¨äº†<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L233">reconcileChildren</a></p>
<h2 id="reconcilerchilren">reconcilerChilren</h2>
<p>ä½œä¸º<code>Reconciler</code>æ¨¡å—çš„æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li>å¯¹äº<code>mount</code>çš„ç»„ä»¶ï¼Œä»–ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>å­FiberèŠ‚ç‚¹</code></li>
<li>å¯¹äº<code>update</code>çš„ç»„ä»¶ï¼Œä»–ä¼šå°†å½“å‰ç»„ä»¶ä¸è¯¥ç»„ä»¶ä¸Šæ¬¡æ›´æ–°æ—¶å¯¹åº”æ—¶<code>Fiber èŠ‚ç‚¹</code>æ¯”è¾ƒï¼ˆ<strong>diffç®—æ³•</strong>ï¼‰ï¼Œå°†æ¯”è¾ƒçš„ç»“æœç”Ÿæˆæ–°çš„<code>FiberèŠ‚ç‚¹</code></li>
</ul>
<pre><code class="language-javascript">function reconcileChildren(
  current: Fiber | null,
  workInProgress: Fiber,
  nextChildren: any,
  renderLanes: Lanes,
) {
  if (current === null) {
    // If this is a fresh new component that hasn't been rendered yet, we
    // won't update its child set by applying minimal side-effects. Instead,
    // we will add them all to the child before it gets rendered. That means
    // we can optimize this reconciliation pass by not tracking side-effects.
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderLanes,
    );
  } else {
    // If the current child is the same as the work in progress, it means that
    // we haven't yet started any work on these children. Therefore, we use
    // the clone algorithm to create a copy of all the current children.

    // If we had any progressed work already, that is invalid at this point so
    // let's throw it out.
    workInProgress.child = reconcileChildFibers(
      workInProgress,
      current.child,
      nextChildren,
      renderLanes,
    );
  }
}
</code></pre>
<blockquote>
<p><code>mountChildFibers</code>å’Œ<code>reconcileChildFibers</code>éƒ½è°ƒç”¨äº†åŒä¸€ä¸ªæ–¹æ³•<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactChildFiber.new.js#L1405">ChildReconciler</a>ï¼Œå”¯ä¸€ä¸åŒçš„ä¸€ç‚¹æ˜¯<code>reconcileChildFibers</code>ä¼šä¸ºç”Ÿæˆçš„<code>FiberèŠ‚ç‚¹</code>å¸¦ä¸Š<code>flags</code>å±æ€§ï¼Œè€Œ<code>mountChildFibers</code>ä¸ä¼š<br>
æœ€ç»ˆä»–ä¼šç”Ÿæˆæ–°çš„<code>å­FiberèŠ‚ç‚¹</code>èµ‹å€¼ç»™<code>workInProgress.child</code>ï¼Œä½œä¸ºæœ¬æ¬¡<code>beginWork</code>çš„è¿”å›å€¼<code>return workInProgress.child</code>ï¼Œå¹¶ä½œä¸ºä¸‹æ¬¡<code>preformUnitOfWork</code>ä¸‹æ¬¡æ‰§è¡Œçš„<code>workInProgress = next</code>ä¼ å‚</p>
</blockquote>
<h2 id="flags">flags</h2>
<ul>
<li>å› ä¸º<strong>Rendereré˜¶æ®µ</strong>æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ï¼Œå½“å·¥ä½œç»“æŸä¹‹åä¼šé€šçŸ¥<code>Renderer</code>éœ€è¦æ‰§è¡Œçš„DOMæ“ä½œï¼›</li>
<li>éœ€è¦æ‰§è¡Œçš„æ“ä½œç±»å‹å°±æ˜¯<code>flags</code></li>
</ul>
<blockquote>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberFlags.js">ReactFiberFlags</a></p>
</blockquote>
<h2 id="beginworkæµç¨‹å›¾">beginWorkæµç¨‹å›¾ï¼š</h2>
<figure data-type="image" tabindex="1"><img src="https://qingwu-aby.github.io/post-images/1602074983811.png" alt="" loading="lazy"></figure>
<h1 id="completework">completeWork</h1>
<blockquote>
<p>ç»„ä»¶æ‰§è¡Œ<code>beginWork</code>ä¹‹åä¼šåˆ›å»º<code>å­FiberèŠ‚ç‚¹</code>ï¼ŒèŠ‚ç‚¹ä¸Šé¢å¯èƒ½å­˜åœ¨<code>flags</code>å±æ€§<br>
<a href="https://github.com/facebook/react/blob/4ead6b53057ee6c6129a6d2f6e264232130b1fce/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L800">completeWork</a></p>
</blockquote>
<p>å’Œ<code>beginWork</code>ç±»ä¼¼ï¼Œ<code>completeWork</code>ä¹Ÿæ˜¯æ ¹æ®ä¸åŒçš„ç±»å‹<code>fiber.tag</code>å¤„ç†ä¸åŒçš„é€»è¾‘</p>
<pre><code class="language-javascript">function completeWork(
    current: Fiber | null,
    workInProgress: Fiber,
    renderLanes: Lanes
): Fiber | null {
    const newProps = workInProgress.pendingProps;
    switch (workInProgress.tag) {
        case IndeterminateComponent:
        case LazyComponent:
        case SimpleMemoComponent:
        case FunctionComponent:
        case ForwardRef:
        case Fragment:
        case Mode:
        case Profiler:
        case ContextConsumer:
        case MemoComponent:
        return null;
        case ClassComponent: {
        // ...çœç•¥
        return null;
        }
        case HostRoot: {
        // ...çœç•¥
        updateHostContainer(workInProgress);
        return null;
        }
        case HostComponent: {
        // ...çœç•¥
        return null;
        }
    }
// ...çœç•¥
}
</code></pre>
<ul>
<li>é¦–å…ˆçœ‹ä¸€ä¸‹ä¸é¡µé¢<code>DOM</code>æ¸²æŸ“ç›¸å…³çš„<code>FiberèŠ‚ç‚¹</code>----<code>HostComponent</code></li>
</ul>
<h2 id="hostcomponet">HostComponet</h2>
<p>ä¸ä¸Šé¢æ‰€è¯´çš„<code>beginWork</code>ç±»ä¼¼çš„æ˜¯ï¼Œæˆ‘ä»¬åŒæ ·æ ¹æ®<code>current === null</code> åˆ¤æ–­å½“å‰é¡µé¢æ˜¯<code>mount</code>è¿˜æ˜¯<code>update</code>ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯åœ¨<code>update</code>çš„æ—¶å€™<code>FiberèŠ‚ç‚¹</code>æ˜¯å¦å­˜åœ¨å¯¹åº”çš„<code>DOMèŠ‚ç‚¹</code>ï¼Œå³<code>workInProgress.stateNode !== null</code></p>
<pre><code class="language-javascript">case HostComponent: {
    popHostContext(workInProgress)
    const rootContainerInstance = getRootHostContainer()
    const type = workInPropgress.type

    if (current !== null &amp;&amp; workInProgress.stateNode !== null) {
        // update,---&gt; ## update
    } else {
        // mount
    }
    return null
}
</code></pre>
<h2 id="update-2">update</h2>
<p>å½“<code>update</code>çš„æ—¶å€™ï¼Œ<code>FiberèŠ‚ç‚¹</code>å·²ç»å­˜åœ¨å¯¹åº”çš„<code>DOMèŠ‚ç‚¹</code>ï¼Œä¸éœ€è¦ç”Ÿæˆ<code>DOM</code>ï¼›ä¸»è¦å·¥ä½œåœ¨äºå¤„ç†<code>props</code>: <strong>äº‹ä»¶å›è°ƒ</strong>ï¼Œ<strong>style</strong>ï¼Œ <strong>children</strong>...</p>
<pre><code class="language-javascript">if (current !== null &amp;&amp; workInProgress.stateNode !== null) {
    //update
    updateHostComponent(
        current,
        workInProgress,
        type,
        newProps,
        rootContainerInstance
    )
}
</code></pre>
<blockquote>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L242">updateHostComponent</a>æ–¹æ³•å®šä¹‰</p>
</blockquote>
<pre><code class="language-javascript"> const updatePayload = prepareUpdate(
      instance,
      type,
      oldProps,
      newProps,
      rootContainerInstance,
      currentHostContext,
    );
    // TODO: Type this specific to this type of component.
    workInProgress.updateQueue = (updatePayload: any);
</code></pre>
<p>åœ¨<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L242">updateHostComponent</a>å†…éƒ¨<code>props</code>å¤„ç†å®Œäº†ä¹‹åï¼Œä¼šèµ‹å€¼ç»™<code>workInProgress.updateQueue = (updatePayload: any)</code>,å¹¶åœ¨æœ€ç»ˆ<code>commité˜¶æ®µ</code>è¿›è¡Œæ¸²æŸ“</p>
<h2 id="mount-2">mount</h2>
<p>åœ¨<code>mount</code>çš„æ—¶å€™ä¸»è¦é€»è¾‘ï¼š</p>
<ul>
<li>ä¸º<code>FiberèŠ‚ç‚¹</code>ç”Ÿæˆå¯¹åº”çš„<code>DOMèŠ‚ç‚¹</code></li>
<li>å°†<code>å­èŠ‚ç‚¹</code>æ’å…¥ç”Ÿæˆçš„<code>DOMèŠ‚ç‚¹</code>ä¸­</li>
<li>å¤„ç†<code>props</code></li>
</ul>
<pre><code class="language-javascript">
const currentHostContext = getHostContext();
// ä¸ºfiberåˆ›å»ºå¯¹åº”DOMèŠ‚ç‚¹
const instance = createInstance(
    type,
    newProps,
    rootContainerInstance,
    currentHostContext,
    workInProgress,
  );
// å°†å­å­™DOMèŠ‚ç‚¹æ’å…¥åˆšç”Ÿæˆçš„DOMèŠ‚ç‚¹ä¸­
appendAllChildren(instance, workInProgress, false, false);
// DOMèŠ‚ç‚¹èµ‹å€¼ç»™fiber.stateNode
workInProgress.stateNode = instance;

// ä¸updateé€»è¾‘ä¸­çš„updateHostComponentç±»ä¼¼çš„å¤„ç†propsçš„è¿‡ç¨‹
if (
  finalizeInitialChildren(
    instance,
    type,
    newProps,
    rootContainerInstance,
    currentHostContext,
  )
) {
  markUpdate(workInProgress);
}
</code></pre>
<blockquote>
<p><code>mount</code>æ—¶åªä¼šåœ¨<code>rootFiber</code>å­˜åœ¨<code>PlaceMent``flags</code>ï¼›<br>
å› ä¸º<code>completeWork</code>æ˜¯å¤„äº<code>å½’</code>é˜¶æ®µè°ƒç”¨çš„æ–¹æ³•ï¼Œæ¯æ¬¡è°ƒç”¨<code>appendAllChildren</code>çš„æ—¶å€™ï¼Œéƒ½ä¼šå°†å·²ç»ç”Ÿæˆçš„<code>å­DOMèŠ‚ç‚¹</code>æ’å…¥åˆ°å½“å‰çš„å·²ç»ç”Ÿæˆçš„<code>DOMèŠ‚ç‚¹ä¸‹</code>ã€‚å½“<strong>å½’</strong>é˜¶æ®µæ‰§è¡Œåˆ°<code>rootFiber</code>æ—¶ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ„å»ºå¥½çš„<code>DOMæ ‘</code></p>
</blockquote>
<h1 id="æµç¨‹ç»“æŸ">æµç¨‹ç»“æŸ</h1>
<p>è‡³æ­¤ï¼Œrenderé˜¶æ®µå…¨éƒ¨å·¥ä½œå®Œæˆã€‚åœ¨performSyncWorkOnRootå‡½æ•°ä¸­fiberRootNodeè¢«ä¼ é€’ç»™commitRootæ–¹æ³•ï¼Œå¼€å¯commité˜¶æ®µå·¥ä½œæµç¨‹ã€‚<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1049">commitRoot</a></p>
<pre><code class="language-javascript">commitRoot(root)
</code></pre>
<h1 id="complete-æµç¨‹å›¾">complete æµç¨‹å›¾</h1>
<figure data-type="image" tabindex="2"><img src="https://qingwu-aby.github.io/post-images/1602148486898.png" alt="" loading="lazy"></figure>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">ä¸‹ä¸€ç¯‡</div>
                                <a href="https://qingwu-aby.github.io/post/BlZ715Y5q/">
                                    <h3 class="post-title">
                                        Reactæºç ç³»åˆ—2----React Fiber
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- è¿”å›é¡¶éƒ¨ -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li><a href="#render-%E6%B5%81%E7%A8%8B">render æµç¨‹</a>
<ul>
<li><a href="#%E9%80%92">'é€’'</a></li>
<li><a href="#%E5%BD%92">'å½’'</a>
<ul>
<li><a href="#example">Exampleï¼š</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#beginwork">beginWork</a>
<ul>
<li><a href="#update">update</a></li>
<li><a href="#mount">mount</a></li>
<li><a href="#reconcilerchilren">reconcilerChilren</a></li>
<li><a href="#flags">flags</a></li>
<li><a href="#beginwork%E6%B5%81%E7%A8%8B%E5%9B%BE">beginWorkæµç¨‹å›¾ï¼š</a></li>
</ul>
</li>
<li><a href="#completework">completeWork</a>
<ul>
<li><a href="#hostcomponet">HostComponet</a></li>
<li><a href="#update-2">update</a></li>
<li><a href="#mount-2">mount</a></li>
</ul>
</li>
<li><a href="#%E6%B5%81%E7%A8%8B%E7%BB%93%E6%9D%9F">æµç¨‹ç»“æŸ</a></li>
<li><a href="#complete-%E6%B5%81%E7%A8%8B%E5%9B%BE">complete æµç¨‹å›¾</a></li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p></p>
</footer>


    <!-- jQuery -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://qingwu-aby.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://qingwu-aby.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://qingwu-aby.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // ä»£ç é«˜äº®
    hljs.initHighlightingOnLoad();

    // img æ‡’åŠ è½½
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // æ‡’åŠ è½½åŠ¨ç”»
            threshold: 180  // åœ¨å›¾ç‰‡è·ç¦»å±å¹•180pxæ—¶æå‰è½½å…¥
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // ç›®å½•
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
</script>




</body>
</html>
