<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>é’å±‹</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="æˆ‘æœ‰ä¸€å£¶é…’ï¼Œè¶³ä»¥æ…°é£å°˜"/>
<meta name="keywords" content="æˆ‘æœ‰ä¸€å£¶é…’ï¼Œè¶³ä»¥æ…°é£å°˜"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://qingwu-aby.github.io/favicon.ico">

<link rel="stylesheet" href="https://qingwu-aby.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://qingwu-aby.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://qingwu-aby.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://qingwu-aby.github.io/images/avatar.png" alt="é’å±‹"
                 class="img-responsive">
        </figure>
        <a href="https://qingwu-aby.github.io/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>é’å±‹</h2>
        <p>æˆ‘æœ‰ä¸€å£¶é…’ï¼Œè¶³ä»¥æ…°é£å°˜</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- æ ‡ç­¾ -->
        <div class="fh5co-box">
            <a href="https://qingwu-aby.github.io/tags/"><h3 class="heading">ğŸ‘‰æ ‡ç­¾</h3></a>
            <ul>
                
                    <li><a href="https://qingwu-aby.github.io/tag/Bo2MqkwLq/">React</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/WHkzkmUVJ/">JSåŸºç¡€</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/HDG5upSe4/">ç®—æ³•å’Œæ•°æ®ç»“æ„</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/o-FN4Uam8n/">todo</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/H8FJNbNzO/">ä¸€äº›é—®é¢˜</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/iheqDLI6k/">åŸ‹ç‚¹</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            é¦–é¡µ
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            åˆ†ç±»
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            æ ‡ç­¾
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            å…³äº
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://qingwu-aby.github.io">é’å±‹ </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>ğŸ‘ˆ Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next ğŸ‘‰</span></a>-->

    <!-- ç­‰grideaå‡ºè‡ªå®šä¹‰é¡µé¢åŠŸèƒ½å†ä¼˜åŒ–ä¸€ä¸‹ -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
            </span>
            <h2 class="fh5co-article-title animate-box">Reactæºç ç³»åˆ—4---commité˜¶æ®µ</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2020-10-06</li>
                <li>2033å­—</li>
                <li>10 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <blockquote>
<p><code>renderé˜¶æ®µ</code>ä¸­æœ€åè°ƒç”¨çš„<code>commitRoot</code>æ˜¯<code>commité˜¶æ®µ</code>çš„å·¥ä½œèµ·ç‚¹ã€‚<code>fiberRootNode</code>ä½œä¸ºä¼ å‚<code>commitRoot(root)</code></p>
</blockquote>
<!-- more -->
<h1 id="commit">commit</h1>
<ul>
<li><s>åœ¨<code>rootFiber.firstEffct</code>ä¸Šä¿å­˜äº†ä¸€æ¡éœ€è¦æ‰§è¡Œ<code>å‰¯ä½œç”¨</code>çš„<code>FiberèŠ‚ç‚¹</code>çš„å•å‘é“¾è¡¨<code>effectList</code></s>,æœ€è¿‘çš„ä¸€æ¬¡æ›´æ–°ä¸­<strong>reactå®˜æ–¹</strong>ä½¿ç”¨äº†<code>subtreeHasEffects</code>å’Œ<code>rootHasEffect</code>è·å–<code>å‰¯ä½œç”¨</code>çš„<code>FiberèŠ‚ç‚¹</code><br>
ï¼Œè¿™äº›<code>FiberèŠ‚ç‚¹</code>çš„<code>updateQueue</code>ä¸­ä¿å­˜äº†å˜åŒ–çš„<code>props</code></li>
<li>è¿™äº›<code>å‰¯ä½œç”¨</code>å¯¹åº”çš„<code>DOMæ“ä½œ</code>ä¼šåœ¨<code>commité˜¶æ®µ</code>æ‰§è¡Œ</li>
<li>éƒ¨åˆ†ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°<code>componentDid***</code>ï¼Œ<code>hook</code>ï¼ˆ<code>useEffect</code>ï¼‰éœ€è¦åœ¨<code>commité˜¶æ®µ</code>æ‰§è¡Œ</li>
</ul>
<p><code>commité˜¶æ®µ</code>çš„ä¸»è¦å·¥ä½œï¼ˆå³<code>Renderer</code>çš„å·¥ä½œæµç¨‹ï¼‰ï¼š</p>
<ol>
<li><code>before mutation</code>é˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOMæ“ä½œ</code>ä¹‹å‰ï¼‰</li>
<li><code>mutation</code>é˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œï¼‰</li>
<li><code>layout</code>é˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œä¹‹åï¼‰</li>
</ol>
<blockquote>
<p><code>commitRootImpl</code>--&gt;<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1784">commitRootImpl</a><br>
åœ¨<code>before mutationé˜¶æ®µ</code>ç»„ä»¶ä¹‹å‰ä»¥åŠ<code>layouté˜¶æ®µä¹‹å</code>è¿˜æ¶‰åŠåˆ°<code>useEffect</code>çš„è§¦å‘ï¼Œ<code>ä¼˜å…ˆçº§</code>é‡ç½®ï¼Œ<code>ref</code>çš„ç»‘å®š/è§£ç»‘ç­‰</p>
</blockquote>
<h2 id="commitæµç¨‹">commitæµç¨‹</h2>
<h3 id="before-mutation-ä¹‹å‰">before mutation ä¹‹å‰</h3>
<p><code>commitRootImpl</code>æ–¹æ³•ä¸­ä¸€ç›´åˆ°<code>if (subtreeHasEffects || rootHasEffect)</code>ä¹‹å‰ï¼Œå±äº<code>before mutationä¹‹å‰</code></p>
<pre><code class="language-javascript">do {
    // `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which
    // means `flushPassiveEffects` will sometimes result in additional
    // passive effects. So we need to keep flushing in a loop until there are
    // no more pending effects.
    // TODO: Might be better if `flushPassiveEffects` did not automatically
    // flush synchronous work at the end, to avoid factoring hazards like this.
    // è§¦å‘useEffectå›è°ƒä¸å…¶ä»–çš„åŒæ­¥ä»»åŠ¡ï¼Œç”±äºå¯èƒ½ä¼šå¼•å‘æ–°çš„æ¸²æŸ“ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦éå†åˆ°æœ€ç»ˆæ²¡æœ‰ä»»åŠ¡ä¸ºæ­¢
    flushPassiveEffects();
  } while (rootWithPendingPassiveEffects !== null);
    // root : fiberRootNode
    // root.finishedLanes æŒ‡å½“å‰åº”ç”¨çš„rootFiber
  const finishedWork = root.finishedWork;
    // lanes ä¸ä¼˜å…ˆçº§ç›¸å…³çš„å˜é‡
  const lanes = root.finishedLanes;

  if (enableSchedulingProfiler) {
    markCommitStarted(lanes);
  }

  if (finishedWork === null) {

    if (enableSchedulingProfiler) {
      markCommitStopped();
    }

    return null;
  }

  // é‡ç½®Schedulerç»‘å®šçš„å›è°ƒ
  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  // commitRoot never returns a continuation; it always finishes synchronously.
  // So we can clear these now to allow a new callback to be scheduled.
  root.callbackNode = null;

  // Update the first and last pending times on this root. The new first
  // pending time is whatever is left on the root fiber.
  let remainingLanes = mergeLanes(finishedWork.lanes, finishedWork.childLanes);
  // é‡ç½®ä¼˜å…ˆçº§å˜é‡
  markRootFinished(root, remainingLanes);

  // Clear already finished discrete updates in case that a later call of
  // `flushDiscreteUpdates` starts a useless render pass which may cancels
  // a scheduled timeout.
  // æ¸…ç†å·²ç»å®Œæˆçš„discrete updatesï¼Œeg: é¼ æ ‡ç‚¹å‡»è§¦å‘çš„æ›´æ–°
  if (rootsWithPendingDiscreteUpdates !== null) {
    if (
      !hasDiscreteLanes(remainingLanes) &amp;&amp;
      rootsWithPendingDiscreteUpdates.has(root)
    ) {
      rootsWithPendingDiscreteUpdates.delete(root);
    }
  }
    // é‡ç½®å…¨å±€å˜é‡
  if (root === workInProgressRoot) {
    // We can reset these now that they are finished.
    workInProgressRoot = null;
    workInProgress = null;
    workInProgressRootRenderLanes = NoLanes;
  } else {
    // This indicates that the last root we worked on is not the same one that
    // we're committing now. This most commonly happens when a suspended root
    // times out.
  }
  // Check if there are any effects in the whole tree.
  // TODO: This is left over from the effect list implementation, where we had
  // to check for the existence of `firstEffect` to satsify Flow. I think the
  // only other reason this optimization exists is because it affects profiling.
  // Reconsider whether this is necessary.
  // åˆ¤æ–­å½“å‰çš„æ ‘ä¸Šé¢æ˜¯å¦è¿˜æœ‰å‰¯ä½œç”¨çš„èŠ‚ç‚¹
  const subtreeHasEffects =
    (finishedWork.subtreeFlags &amp;
      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
    NoFlags;
  const rootHasEffect =
    (finishedWork.flags &amp;
      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
    NoFlags;
    if (subtreeHasEffects || rootHasEffect) {

    } else {
        // No effects.
        root.current = finishedWork;
        // Measure these anyway so the flamegraph explicitly shows that there were
        // no effects.
        // TODO: Maybe there's a better way to report this.
        if (enableProfilerTimer) {
            recordCommitTime();
        }
    }
</code></pre>
<blockquote>
<p><code>before mutationä¹‹å‰</code>çš„é˜¶æ®µéƒ½æ˜¯åœ¨å¤„ç†å˜é‡çš„èµ‹å€¼ï¼Œä»¥åŠçŠ¶æ€çš„é‡ç½®ç­‰æ“ä½œ</p>
</blockquote>
<h3 id="layout-ä¹‹å">layout ä¹‹å</h3>
<pre><code class="language-javascript">const rootDidHavePassiveEffects = rootDoesHavePassiveEffects;

// useEffectç›¸å…³
if (rootDoesHavePassiveEffects) {
  rootDoesHavePassiveEffects = false;
  rootWithPendingPassiveEffects = root;
  pendingPassiveEffectsLanes = lanes;
  pendingPassiveEffectsRenderPriority = renderPriorityLevel;
} else {}

// æ€§èƒ½ä¼˜åŒ–ç›¸å…³
if (remainingLanes !== NoLanes) {
  if (enableSchedulerTracing) {
    // ...
  }
} else {
  // ...
}

// æ€§èƒ½ä¼˜åŒ–ç›¸å…³
if (enableSchedulerTracing) {
  if (!rootDidHavePassiveEffects) {
    // ...
  }
}

// ...æ£€æµ‹æ— é™å¾ªç¯çš„åŒæ­¥ä»»åŠ¡
if (remainingLanes === SyncLane) {
  // ...
} 

// åœ¨ç¦»å¼€commitRootå‡½æ•°å‰è°ƒç”¨ï¼Œè§¦å‘ä¸€æ¬¡æ–°çš„è°ƒåº¦ï¼Œç¡®ä¿ä»»ä½•é™„åŠ çš„ä»»åŠ¡è¢«è°ƒåº¦
ensureRootIsScheduled(root, now());

// ...å¤„ç†æœªæ•è·é”™è¯¯åŠè€ç‰ˆæœ¬é—ç•™çš„è¾¹ç•Œé—®é¢˜
// æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼Œè¿™æ ·åŒæ­¥ä»»åŠ¡ä¸éœ€è¦ç­‰åˆ°ä¸‹æ¬¡äº‹ä»¶å¾ªç¯å†æ‰§è¡Œ
// æ¯”å¦‚åœ¨ componentDidMount ä¸­æ‰§è¡Œ setState åˆ›å»ºçš„æ›´æ–°ä¼šåœ¨è¿™é‡Œè¢«åŒæ­¥æ‰§è¡Œ
// æˆ–useLayoutEffect
flushSyncCallbackQueue();
return null;
</code></pre>
<p>ä¸»è¦åŒ…å«ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ol>
<li><code>useEffect</code>çš„ç›¸å…³å¤„ç†</li>
<li>æ€§èƒ½è¿½è¸ª</li>
<li>åœ¨<code>commit</code>é˜¶æ®µä¼šè§¦å‘ä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­(<code>componentDid***</code>)å’Œ<code>hook</code>ï¼ˆ<code>useLayoutEffect</code>, <code>useEffect</code>ï¼‰</li>
</ol>
<blockquote>
<p>åœ¨è¿™äº›å›è°ƒæ–¹æ³•ä¸­å¯èƒ½ä¼šè§¦å‘æ–°çš„æ›´æ–°ï¼Œæ–°çš„æ›´æ–°ä¼šå¼€å¯æ–°çš„<code>render-commit</code>è¿‡ç¨‹ï¼Œä¾‹å¦‚ï¼š</p>
<ol>
<li>è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œé¡µé¢ä¸­ä»¤ä¸€ä¸ªçŠ¶æ€å˜ä¸º<code>0</code></li>
<li>åœ¨<code>useLayoutEffect</code>ä¸­è®¾ç½®ä¸ºéšæœºæ•°</li>
<li>é¡µé¢ä¸Šæ¸²æŸ“çš„æ•°å­—ä¸æ˜¯<code>0</code>ï¼Œè€Œæ˜¯å˜æˆéšæœºæ•°</li>
</ol>
</blockquote>
<p>å› ä¸º<code>useEffectLayout</code>åœ¨<code>layouté˜¶æ®µ</code>åŒæ­¥æ‰§è¡Œå›è°ƒï¼Œå›è°ƒä¸­è§¦å‘çŠ¶æ€æ›´æ–°ï¼Œè¿™ä¸ªæ“ä½œä¼šé‡æ–°è°ƒåº¦ä¸€ä¸ªæ–°çš„ä»»åŠ¡:---&gt;<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2114">flushSyncCallbackQueue</a></p>
<pre><code class="language-javascript">// If layout work was scheduled, flush it now.
  flushSyncCallbackQueue();
</code></pre>
<p>æ‰€ä»¥çœ‹ä¸åˆ°é¡µé¢ä¸­çš„æ•°å­—å…ˆå˜æˆ<code>0</code></p>
<h2 id="before-mutation">before mutation</h2>
<p><code>Renderer</code>å·¥ä½œçš„é˜¶æ®µè¢«ç§°ä¸º<code>commité˜¶æ®µ</code>ï¼Œ<code>commité˜¶æ®µ</code>åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†</p>
<ul>
<li>
<p>before mutationï¼ˆæ‰§è¡Œ<code>DOMæ“ä½œå‰</code>ï¼‰</p>
</li>
<li>
<p>mutationé˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œï¼‰</p>
</li>
<li>
<p>layouté˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œä¹‹åï¼‰</p>
<blockquote>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1882-L1909">before mutationé˜¶æ®µ</a></p>
</blockquote>
<pre><code class="language-javascript">// ä¿å­˜ä¹‹å‰çš„ä¼˜å…ˆçº§ï¼Œä»¥åŒæ­¥ä¼˜å…ˆçº§æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åæ¢å¤ä¹‹å‰ä¼˜å…ˆçº§
</code></pre>
</li>
</ul>
<p>const previousLanePriority = getCurrentUpdateLanePriority();<br>
setCurrentUpdateLanePriority(SyncLanePriority);</p>
<p>// å°†å½“å‰ä¸Šä¸‹æ–‡æ ‡è®°ä¸ºCommitContextï¼Œä½œä¸ºcommité˜¶æ®µçš„æ ‡å¿—<br>
const prevExecutionContext = executionContext;<br>
executionContext |= CommitContext;</p>
<p>// å¤„ç†focusçŠ¶æ€<br>
focusedInstanceHandle = prepareForCommit(root.containerInfo);<br>
shouldFireAfterActiveInstanceBlur = false;</p>
<p>// beforeMutationé˜¶æ®µçš„ä¸»å‡½æ•°<br>
commitBeforeMutationEffects(finishedWork);</p>
<p>focusedInstanceHandle = null;</p>
<pre><code>è¿™é‡Œéœ€è¦å…³æ³¨ä¸»å‡½æ•°`commitBeforeMutationEffects`çš„ä½œç”¨

### commitBeforeMutationEffects

`commitBeforeMutationEffects` ç›´æ¥å»è°ƒåº¦`commitBeforeMutationEffectsImpl`
ä»£ç é€»è¾‘ï¼š
``` javascript
function commitBeforeMutationEffects(firstChild: Fiber) {
let fiber = firstChild;
while (fiber !== null) {
  if (fiber.deletions !== null) {
    commitBeforeMutationEffectsDeletions(fiber.deletions);
  }
  if (fiber.child !== null) {
    const primarySubtreeFlags = fiber.subtreeFlags &amp; BeforeMutationMask;
    if (primarySubtreeFlags !== NoFlags) {
      commitBeforeMutationEffects(fiber.child);
    }
  }

 try {
      commitBeforeMutationEffectsImpl(fiber);
    } catch (error) {
      captureCommitPhaseError(fiber, fiber.return, error);
    }
  fiber = fiber.sibling;
}
}
</code></pre>
<p>commitBeforeMutationEffectsImpl:</p>
<pre><code class="language-javascript">function commitBeforeMutationEffectsImpl(fiber: Fiber) {
  const current = fiber.alternate;
  const flags = fiber.flags;
// focusç›¸å…³
  if (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== null) {
    // Check to see if the focused element was inside of a hidden (Suspense) subtree.
    // TODO: Move this out of the hot path using a dedicated effect tag.
    if (
      fiber.tag === SuspenseComponent &amp;&amp;
      isSuspenseBoundaryBeingHidden(current, fiber) &amp;&amp;
      doesFiberContain(fiber, focusedInstanceHandle)
    ) {
      shouldFireAfterActiveInstanceBlur = true;
      beforeActiveInstanceBlur();
    }
  }
  // è°ƒç”¨getSnapshotBeforeUpdate

  if ((flags &amp; Snapshot) !== NoFlags) {
    setCurrentDebugFiberInDEV(fiber);
    commitBeforeMutationEffectOnFiber(current, fiber);
    resetCurrentDebugFiberInDEV();
  }
 // è°ƒåº¦useEffect
  if ((flags &amp; Passive) !== NoFlags) {
    // If there are passive effects, schedule a callback to flush at
    // the earliest opportunity.
    if (!rootDoesHavePassiveEffects) {
      rootDoesHavePassiveEffects = true;
      scheduleCallback(NormalSchedulerPriority, () =&gt; {
        flushPassiveEffects();
        return null;
      });
    }
  }
}
</code></pre>
<p>æ•´ä½“åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>å¤„ç†<code>DOMèŠ‚ç‚¹</code>æ¸²æŸ“/åˆ é™¤åçš„<code>autoFocus</code>ï¼Œ<code>blur</code>é€»è¾‘</li>
<li>è°ƒç”¨<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸé’©å­</li>
<li>è°ƒåº¦<code>useEffect</code></li>
</ol>
<h3 id="è°ƒç”¨getsnapshotbeforeupdate">è°ƒç”¨getSnapshotBeforeUpdate</h3>
<blockquote>
<p><code>commitBeforeMutationEffectOnFiber</code>æ˜¯<code>commitBeforeMutationLifeCycles</code>çš„åˆ«å,<br>
è¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨<code>getSnapshotBeforeUpdate</code>:<br>
<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L237">commitBeforeMutationLifeCyclesæ–¹æ³•</a></p>
</blockquote>
<pre><code class="language-javascript">const snapshot = instance.getSnapshotBeforeUpdate(
    finishedWork.elementType === finishedWork.type
        ? prevProps
        : resolveDefaultProps(finishedWork.type, prevProps),
    prevState,
);
</code></pre>
<p><code>getSnapshotBeforeUpdate</code>åœ¨<code>commité˜¶æ®µ</code>å†…çš„<code>before mutation</code>é˜¶æ®µè°ƒç”¨çš„ï¼Œç”±äº<code>commit</code>æ˜¯åŒæ­¥è¿›è¡Œçš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¤šæ¬¡è°ƒç”¨çš„é—®é¢˜</p>
<h3 id="è°ƒåº¦useeffect">è°ƒåº¦useEffect</h3>
<p><code>scheduleCallback</code>æ–¹æ³•å°±æ˜¯ç”±<code>Scheduler</code>æ¨¡å—æä¾›ï¼Œç”¨äºæŸä¸ªä¼˜å…ˆçº§å¼‚æ­¥è°ƒåº¦ä¸€ä¸ªå›è°ƒå‡½æ•°</p>
<pre><code class="language-javascript">// è°ƒåº¦useEffect
if ((flags &amp; Passive) !== NoFlags) {
    // If there are passive effects, schedule a callback to flush at
    // the earliest opportunity.
    if (!rootDoesHavePassiveEffects) {
      rootDoesHavePassiveEffects = true;
      scheduleCallback(NormalSchedulerPriority, () =&gt; {
        flushPassiveEffects();
        return null;
      });
    }
  }
</code></pre>
<p>æ­¤å¤„ï¼Œè¢«å¼‚æ­¥è°ƒåº¦çš„å›è°ƒå‡½æ•°å°±æ˜¯è§¦å‘<code>useEffect</code>çš„æ–¹æ³•<code>flushPassiveEffects</code></p>
<h4 id="å¦‚ä½•å¼‚æ­¥è°ƒåº¦">å¦‚ä½•å¼‚æ­¥è°ƒåº¦</h4>
<pre><code class="language-javascript">export function flushPassiveEffects(): boolean {
  // Returns whether passive effects were flushed.
  if (pendingPassiveEffectsRenderPriority !== NoSchedulerPriority) {
    const priorityLevel =
      pendingPassiveEffectsRenderPriority &gt; NormalSchedulerPriority
        ? NormalSchedulerPriority
        : pendingPassiveEffectsRenderPriority;
    pendingPassiveEffectsRenderPriority = NoSchedulerPriority;
    if (decoupleUpdatePriorityFromScheduler) {
      const previousLanePriority = getCurrentUpdateLanePriority();
      try {
        setCurrentUpdateLanePriority(
          schedulerPriorityToLanePriority(priorityLevel),
        );
        return runWithPriority(priorityLevel, flushPassiveEffectsImpl);
      } finally {
        setCurrentUpdateLanePriority(previousLanePriority);
      }
    } else {
      return runWithPriority(priorityLevel, flushPassiveEffectsImpl);
    }
  }
  return false;
}
</code></pre>
<p>é€šè¿‡ä¹‹å‰çš„äº†è§£<code>renderé˜¶æ®µ</code>ï¼š<code>FiberèŠ‚ç‚¹</code>æ›´æ–°è¿‡ç¨‹ä¸­çš„å‰¯ä½œç”¨åŒ…æ‹¬</p>
<ol>
<li>æ’å…¥<code>DOMèŠ‚ç‚¹</code>ï¼ˆPlacementï¼‰</li>
<li>åˆ é™¤<code>DOMèŠ‚ç‚¹</code>ï¼ˆDeletionï¼‰</li>
<li>æ›´æ–°<code>DOMèŠ‚ç‚¹</code>ï¼ˆUpdateï¼‰<br>
é™¤æ­¤ä¹‹å¤–ï¼Œå½“ä¸€ä¸ª<code>FunctionComponent</code>å«æœ‰<code>useEffect</code>æˆ–è€…<code>useLayoutEffect</code>çš„æ—¶å€™ï¼Œä»–å¯¹åº”çš„<code>FiberèŠ‚ç‚¹</code>ä¹Ÿä¼šè¢«èµ‹å€¼<code>flags</code></li>
</ol>
<p>åœ¨<code>commitRootImpl</code>æ–¹æ³•ä¸­ä¼šå¾ªç¯éå†<code>rootWithPendingPassiveEffects</code>æ‰§è¡Œæœ‰å‰¯ä½œç”¨çš„å›è°ƒå‡½æ•°</p>
<p>æ•´ä¸ª<code>useEffect</code>çš„å¼‚æ­¥è°ƒç”¨åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><code>before mutation</code>é˜¶æ®µåœ¨<code>scheduleCallback</code>ä¸­è°ƒåº¦<code>flushPassiveEffects</code></li>
<li><code>layout</code>é˜¶æ®µä¹‹åå°†effectListèµ‹å€¼ç»™<code>rootWithPendingPassiveEffects</code></li>
<li><code>scheduleCallback</code>è§¦å‘<code>flushPassiveEffects</code>ï¼Œ<code>flushPassiveEffects</code>å†…éƒ¨éå†<code>rootWithPendingPassiveEffects</code></li>
</ol>
<blockquote>
<p><code>useEffect</code>: åœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶ä¹‹åï¼Œä¼ é€’ç»™useEffectçš„å‡½æ•°ä¼šå»¶è¿Ÿè°ƒç”¨</p>
</blockquote>
<p>ä½¿ç”¨<code>useEffect</code>å¼‚æ­¥æ‰§è¡Œçš„åŸå› ä¸»è¦æ˜¯ä¸ºäº†çººç»‡åŒæ­¥æ‰§è¡Œæ—¶é˜»å¡æµè§ˆå™¨çš„æ¸²æŸ“</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p><code>before mutation</code>é˜¶æ®µä¼šé€šè¿‡<code>commitBeforeMutationEffects</code>å»éå†æœ‰<code>effect</code>çš„<code>FiberèŠ‚ç‚¹</code>ï¼š</p>
<ol>
<li>å¤„ç†DOMèŠ‚ç‚¹<strong>æ¸²æŸ“/åˆ é™¤</strong>åçš„<code>Focus</code>/<code>onblur</code>é€»è¾‘</li>
<li>è°ƒç”¨<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸ</li>
<li>è°ƒåº¦<code>useEffect</code></li>
</ol>
<h2 id="mutationé˜¶æ®µ">mutationé˜¶æ®µ</h2>
<p>ä¸<code>before mutationé˜¶æ®µ</code>ç›¸ä¼¼çš„æ˜¯<code>mutationé˜¶æ®µ</code>ä¹Ÿä¼šå»éå†<code>effect</code>çš„<code>FiberèŠ‚ç‚¹</code>ï¼Œä¸åŒçš„æ˜¯ï¼š<code>mutationé˜¶æ®µ</code>è°ƒç”¨çš„æ˜¯<code>commitBeforeMutationEffects</code>æ–¹æ³•</p>
<pre><code class="language-javascript"> // The next phase is the mutation phase, where we mutate the host tree.
    commitMutationEffects(finishedWork, root, renderPriorityLevel);

    if (shouldFireAfterActiveInstanceBlur) {
      afterActiveInstanceBlur();
    }
    resetAfterCommit(root.containerInfo);

    // The work-in-progress tree is now the current tree. This must come after
    // the mutation phase, so that the previous tree is still current during
    // componentWillUnmount, but before the layout phase, so that the finished
    // work is current during componentDidMount/Update.
    root.current = finishedWork;
</code></pre>
<h4 id="æ€»ç»“-2">æ€»ç»“</h4>
<p><code>mutationé˜¶æ®µ</code>ä¼šéå†æœ‰<code>effect</code>çš„<code>FiberèŠ‚ç‚¹</code>ï¼Œä¸»è¦æ–¹æ³•åœ¨<code>commitMutationEffects</code>ï¼Œæ ¹æ®<code>flags</code>çŠ¶æ€çš„ä¸åŒè°ƒç”¨ä¸åŒçš„å¤„ç†æ–¹æ³•å»å¤„ç†<code>Fiber</code></p>
<h2 id="layouté˜¶æ®µ">layouté˜¶æ®µ</h2>
<ul>
<li>åœ¨å½“å‰é˜¶æ®µä»£ç éƒ½åœ¨<code>DOM</code>æ¸²æŸ“å®Œæˆ(<code>mutationé˜¶æ®µ</code>)ä¹‹åæ‰§è¡Œçš„</li>
<li>å½“å‰é˜¶æ®µè§¦å‘çš„ç”Ÿå‘½å‘¨æœŸé’©å­å’Œ<code>hook</code>å¯ä»¥ç›´æ¥è®¿é—®åˆ°å·²ç»æ”¹å˜ä¹‹åçš„<code>DOM</code>ï¼Œå½“å‰é˜¶æ®µå¯ä»¥ç›´æ¥å‚ä¸<code>DOM layout</code>çš„é˜¶æ®µ</li>
</ul>
<h3 id=""></h3>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">ä¸‹ä¸€ç¯‡</div>
                                <a href="https://qingwu-aby.github.io/post/85DIMWyxi/">
                                    <h3 class="post-title">
                                        Reactæºç ç³»åˆ—3---Renderé˜¶æ®µ
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- è¿”å›é¡¶éƒ¨ -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li><a href="#commit">commit</a>
<ul>
<li><a href="#commit%E6%B5%81%E7%A8%8B">commitæµç¨‹</a>
<ul>
<li><a href="#before-mutation-%E4%B9%8B%E5%89%8D">before mutation ä¹‹å‰</a></li>
<li><a href="#layout-%E4%B9%8B%E5%90%8E">layout ä¹‹å</a></li>
</ul>
</li>
<li><a href="#before-mutation">before mutation</a>
<ul>
<li><a href="#%E8%B0%83%E7%94%A8getsnapshotbeforeupdate">è°ƒç”¨getSnapshotBeforeUpdate</a></li>
<li><a href="#%E8%B0%83%E5%BA%A6useeffect">è°ƒåº¦useEffect</a>
<ul>
<li><a href="#%E5%A6%82%E4%BD%95%E5%BC%82%E6%AD%A5%E8%B0%83%E5%BA%A6">å¦‚ä½•å¼‚æ­¥è°ƒåº¦</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>
</li>
<li><a href="#mutation%E9%98%B6%E6%AE%B5">mutationé˜¶æ®µ</a><br>
*
<ul>
<li><a href="#%E6%80%BB%E7%BB%93-2">æ€»ç»“</a></li>
</ul>
</li>
<li><a href="#layout%E9%98%B6%E6%AE%B5">layouté˜¶æ®µ</a><br>
*</li>
</ul>
</li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p></p>
</footer>


    <!-- jQuery -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://qingwu-aby.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://qingwu-aby.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://qingwu-aby.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://qingwu-aby.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // ä»£ç é«˜äº®
    hljs.initHighlightingOnLoad();

    // img æ‡’åŠ è½½
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // æ‡’åŠ è½½åŠ¨ç”»
            threshold: 180  // åœ¨å›¾ç‰‡è·ç¦»å±å¹•180pxæ—¶æå‰è½½å…¥
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // ç›®å½•
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
</script>




</body>
</html>
