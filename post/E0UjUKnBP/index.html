<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>青屋</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="我有一壶酒，足以慰风尘"/>
<meta name="keywords" content="我有一壶酒，足以慰风尘"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://qingwu-aby.github.io//favicon.ico">

<link rel="stylesheet" href="https://qingwu-aby.github.io//styles/main.css">

<!-- Modernizr JS -->
<script src="https://qingwu-aby.github.io//media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://qingwu-aby.github.io//media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://qingwu-aby.github.io//images/avatar.png" alt="青屋"
                 class="img-responsive">
        </figure>
        <a href="https://qingwu-aby.github.io//post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>青屋</h2>
        <p>我有一壶酒，足以慰风尘</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- 标签 -->
        <div class="fh5co-box">
            <a href="https://qingwu-aby.github.io//tags/"><h3 class="heading">👉标签</h3></a>
            <ul>
                
                    <li><a href="https://qingwu-aby.github.io/tag/WHkzkmUVJ/">JS基础</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/HDG5upSe4/">算法和数据结构</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/o-FN4Uam8n/">todo</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/H8FJNbNzO/">一些问题</a></li>
                
                    <li><a href="https://qingwu-aby.github.io/tag/iheqDLI6k/">埋点</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            标签
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            关于
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://qingwu-aby.github.io/">青屋 </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

    <!-- 等gridea出自定义页面功能再优化一下 -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
            </span>
            <h2 class="fh5co-article-title animate-box">React源码系列1---React15和16的差别</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2020-09-23</li>
                <li>874字</li>
                <li>4 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <p>React不同版本源码的差异</p>
<!-- more -->
<p><strong>React的理念</strong></p>
<blockquote>
<p>速度快，响应自然</p>
</blockquote>
<h1 id="react的架构">React的架构</h1>
<h2 id="react15">React15</h2>
<ul>
<li>Reconciler——找出发生变化的组件</li>
<li>Renderer——渲染发生变化的组件</li>
</ul>
<h3 id="reconciler">Reconciler</h3>
<blockquote>
<p><code>React</code>中会通过<code>this.setState</code>,<code>this.forceUpdate</code>,<code>ReactDom.render</code>等方法更新组件</p>
<ul>
<li>调用函数组件、class组件的<code>render</code>方法，将返回的JSX转换为虚拟DOM</li>
<li>将虚拟DOM与上次的进行比较</li>
<li>找出本次发生更新的虚拟DOM</li>
<li>通知<strong>Renderer</strong>将变化的虚拟DOM渲染到页面上</li>
</ul>
</blockquote>
<h3 id="renderer">Renderer</h3>
<blockquote>
<p>每次更新发生的时候，<strong>Renderer</strong>接收到<strong>Reconciler</strong>的通知，将变化的组件渲染到当前的宿主环境</p>
</blockquote>
<h3 id="react15的缺陷">React15的缺陷</h3>
<p><strong>无法支持同步更新</strong><br>
<strong>递归的去更新会导致某写情况下页面的渲染结果不一致</strong></p>
<blockquote>
<p>在<code>Reconciler</code>中，<code>update</code>的组件会调用<code>updateComponent</code>,<code>mount</code>的组件会调用<code>mountComponent</code>，这两个方法都是递归执行的</p>
<p>JS是一门单线程的语言，他的<code>GUI渲染线程</code>和<code>JS主线程</code>是互斥的，也就是说在页面执行我们的js代码的时候是不能够去渲染和绘制页面的，在我们渲染每一帧页面的时候：</p>
</blockquote>
<pre><code>JS代码执行-------样式布局-------样式绘制
</code></pre>
<blockquote>
<ul>
<li>当JS代码执行的时间超过每一帧的时长的时候，页面上就无法反映出本次渲染的结果</li>
<li>同时，对于<code>React</code>来说，因为递归执行的原因，所以会导致页面一旦开始更新就无法终止；如果我们页面的层级变得很深，就会导致递归更新的时间过长，页面无法渲染</li>
<li><strong>Scheduler</strong>和<strong>Reconciler</strong>是交替渲染的</li>
</ul>
</blockquote>
<h2 id="react16">React16</h2>
<blockquote>
<p><code>React16</code>的架构有三层：</p>
<ul>
<li>Schduler（调度器）——调度人物的优先级，高优先级任务优先进入<strong>Reconciler</strong></li>
<li>Reconciler（协调器）——找出变化的组件（<code>Fiber</code>架构？）</li>
<li>Renderer（渲染器）——将变化的组件渲染到页面上</li>
</ul>
<blockquote>
<p>其中<strong>Scheduler</strong>和<strong>Reconciler</strong>是平台无关的</p>
</blockquote>
</blockquote>
<h3 id="scheduler调度器">Scheduler（调度器）</h3>
<blockquote>
<p>我们以浏览器每一帧是否有剩余时间作为任务中断的标准，需要有一种机制通知我们浏览器什么时候有剩余时间----<code>requestIdleCallback</code><br>
<code>React</code>实现了<code>requestIdleCallback</code>的polyfill---<strong>Scheduler</strong>；除了在浏览器空闲时间触发回调，还提供了多种调度优先级</p>
</blockquote>
<h3 id="reconciler协调器">Reconciler（协调器）</h3>
<blockquote>
<p>在<code>React15</code>中，<strong>Reconciler</strong>是递归处理虚拟DOM的<br>
<code>React16</code>中更新的过程从递归变成了可以终中断的循环过程，每一次循环都回去调用<code>shouleYield</code>判断当前是否有剩余时间</p>
</blockquote>
<pre><code class="language-javascript">function workLoopConcurrent() {
    while(workInProgress !== null &amp;&amp; !shouldYield()) {
        workInProgress = performUnitOfWork(workInProgress)
    }
}
</code></pre>
<blockquote>
<p>关于<code>React15</code>中的因为一些特殊原因导致中断更新的时候DOM渲染不完全的问题</p>
<p>在<code>React16</code>中，<strong>Reconciler</strong>和<strong>Renderer</strong>不是交替工作的。当<strong>Scheduler</strong>将任务交给<strong>Reconciler</strong>的时候，<strong>Reconciler</strong>会为变化的虚拟DOM搭上增/删/更新的标记</p>
<blockquote>
<p>其他的<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js">标记</a><br>
因为整个<strong>Scheduler</strong>和<strong>Reconciler</strong>的过程都是在内存中进行的。只有当组件都完成在<strong>Reconciler</strong>的工作，才会统一交给<strong>Renderer</strong></p>
</blockquote>
</blockquote>
<h3 id="renderer渲染器">Renderer（渲染器）</h3>
<blockquote>
<p><strong>Renderer</strong>根据<strong>Reconciler</strong>为虚拟DOM的打上的标记，同步执行对应的DOM操作。<br>
<strong>Scheduler</strong>和<strong>Reconciler</strong>中的步骤随时会因为，有更高优先级的任务进来，或者当前帧没有剩余时间而中断。因为 <strong>Scheduler</strong>和<strong>Reconciler</strong>中的工作都是在内存中进行的，并不会更新页面，所以即使这个里面出现反复中断，也不会影响用户的体验（看见部分DOM更新不完全）</p>
</blockquote>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">下一篇</div>
                                <a href="https://qingwu-aby.github.io/post/tui-jin-jie-zou/">
                                    <h3 class="post-title">
                                        前端的一些重点
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- 返回顶部 -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li><a href="#react%E7%9A%84%E6%9E%B6%E6%9E%84">React的架构</a>
<ul>
<li><a href="#react15">React15</a>
<ul>
<li><a href="#reconciler">Reconciler</a></li>
<li><a href="#renderer">Renderer</a></li>
<li><a href="#react15%E7%9A%84%E7%BC%BA%E9%99%B7">React15的缺陷</a></li>
</ul>
</li>
<li><a href="#react16">React16</a>
<ul>
<li><a href="#scheduler%E8%B0%83%E5%BA%A6%E5%99%A8">Scheduler（调度器）</a></li>
<li><a href="#reconciler%E5%8D%8F%E8%B0%83%E5%99%A8">Reconciler（协调器）</a></li>
<li><a href="#renderer%E6%B8%B2%E6%9F%93%E5%99%A8">Renderer（渲染器）</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p></p>
</footer>


    <!-- jQuery -->
<script src="https://qingwu-aby.github.io//media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://qingwu-aby.github.io//media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://qingwu-aby.github.io//media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://qingwu-aby.github.io//media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://qingwu-aby.github.io//media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://qingwu-aby.github.io//media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://qingwu-aby.github.io//media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // 代码高亮
    hljs.initHighlightingOnLoad();

    // img 懒加载
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // 懒加载动画
            threshold: 180  // 在图片距离屏幕180px时提前载入
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // 目录
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
</script>




</body>
</html>
